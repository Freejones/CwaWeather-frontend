<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>自由的臺灣天氣 | Free Taiwan Weather</title>
    
    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Shippori+Mincho:wght@500;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'tech-black': '#050505',
                        'tech-gray': '#1a1a1a',
                        'tech-line': '#333333',
                        'tech-accent': '#00f0ff', // Cyber Cyan
                        'tech-alert': '#ff3300', // EVA Orange/Red
                    },
                    fontFamily: {
                        'eva': ['"Shippori Mincho"', 'serif'],
                        'mono': ['"JetBrains Mono"', 'monospace'],
                    }
                }
            }
        }
    </script>

    <style>
        /* 全局樣式 */
        body {
            background-color: #050505;
            color: #e5e5e5;
            overflow-x: hidden; /* iOS 禁止左右滑動 */
            -webkit-font-smoothing: antialiased;
        }

        /* 模擬 CRT 掃描線效果 (選用，增加科技感) */
        .scanline {
            width: 100%;
            height: 100px;
            z-index: 10;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(255, 255, 255, 0.02) 50%, rgba(0,0,0,0) 100%);
            opacity: 0.1;
            position: absolute;
            bottom: 100%;
            animation: scanline 10s linear infinite;
            pointer-events: none;
        }

        @keyframes scanline {
            0% { bottom: 100%; }
            100% { bottom: -100%; }
        }

        /* 下拉選單自訂樣式 */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: transparent;
            border: 1px solid #333;
            border-radius: 0;
            color: #fff;
            padding: 0.5rem 2rem 0.5rem 1rem;
            cursor: pointer;
            font-family: 'Shippori Mincho', serif;
            font-weight: 700;
        }
        
        select:focus {
            outline: none;
            border-color: #00f0ff;
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.2);
        }

        /* EVA 風格邊框 */
        .border-corner {
            position: relative;
            border: 1px solid #333;
        }
        .border-corner::before, .border-corner::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            transition: all 0.3s ease;
        }
        .border-corner::before {
            top: -1px;
            left: -1px;
            border-top: 2px solid #00f0ff;
            border-left: 2px solid #00f0ff;
        }
        .border-corner::after {
            bottom: -1px;
            right: -1px;
            border-bottom: 2px solid #00f0ff;
            border-right: 2px solid #00f0ff;
        }

        /* 載入動畫 */
        .loader {
            border: 2px solid #333;
            border-top: 2px solid #00f0ff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 明朝體極粗標題修正 */
        .eva-title {
            transform: scaleY(1.1); /* 讓字體看起來更修長 */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <div class="fixed inset-0 pointer-events-none overflow-hidden h-full w-full">
        <div class="scanline"></div>
    </div>

    <header class="w-full border-b border-tech-line bg-tech-black/90 backdrop-blur-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 bg-tech-accent animate-pulse"></div>
                <h1 class="font-eva font-extrabold text-2xl tracking-widest eva-title text-white">
                    自由的臺灣天氣
                </h1>
            </div>
            <div class="hidden md:flex font-mono text-xs text-gray-500 gap-4">
                <span>SYSTEM: ONLINE</span>
                <span id="system-time">00:00:00</span>
            </div>
        </div>
    </header>

    <main class="flex-grow max-w-7xl mx-auto w-full px-4 py-8 grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <section class="lg:col-span-7 flex flex-col gap-6">
            
            <div class="border-corner bg-tech-gray/20 p-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                <div class="flex flex-col gap-2 w-full">
                    <label class="font-mono text-xs text-tech-accent uppercase tracking-widest">Target Sector</label>
                    <div class="relative w-full">
                        <select id="city-select" class="w-full text-xl bg-black/50 hover:bg-black/80 transition-colors">
                            <option value="" disabled selected>定位中...</option>
                            </select>
                        <div class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-tech-accent">
                            <i data-lucide="chevron-down" class="w-4 h-4"></i>
                        </div>
                    </div>
                </div>
                
                <button id="locate-btn" class="font-mono text-xs border border-tech-line px-4 py-3 hover:bg-tech-accent hover:text-black transition-colors flex items-center gap-2 whitespace-nowrap justify-center group">
                    <i data-lucide="crosshair" class="w-4 h-4 group-hover:rotate-90 transition-transform"></i>
                    RE-LOCATE
                </button>
            </div>

            <div class="border-corner bg-tech-black p-8 flex-grow flex flex-col justify-center relative overflow-hidden min-h-[300px]">
                <div class="absolute -right-10 -bottom-10 text-[10rem] font-eva font-black text-white/5 select-none pointer-events-none eva-title z-0" id="bg-temp">
                    --
                </div>

                <div class="relative z-10">
                    <div class="flex items-start justify-between mb-4">
                        <span class="font-mono text-xs border border-tech-accent text-tech-accent px-2 py-0.5">LIVE DATA</span>
                        <div id="loading-indicator" class="loader opacity-0 transition-opacity"></div>
                    </div>

                    <div class="flex flex-col md:flex-row items-center md:items-end gap-6 mb-8">
                        <div class="flex items-start">
                            <span id="main-temp" class="font-mono text-8xl md:text-9xl font-bold tracking-tighter text-white">--</span>
                            <span class="font-mono text-2xl text-gray-500 mt-4">°C</span>
                        </div>
                        <div class="flex flex-col items-center md:items-start pb-4">
                            <div id="weather-icon-container" class="text-tech-accent mb-2">
                                <i data-lucide="activity" class="w-24 h-24"></i>
                            </div>
                            <span id="weather-desc" class="font-eva text-3xl font-bold tracking-wide">載入中</span>
                        </div>
                    </div>

                    <div class="h-px w-full bg-gradient-to-r from-tech-accent/50 to-transparent mb-6"></div>

                    <p class="font-eva text-gray-400 text-sm md:text-base leading-loose max-w-2xl" id="weather-detail">
                        正在連線至中央氣象署資料庫...
                    </p>
                </div>
            </div>
        </section>

        <section class="lg:col-span-5 grid grid-cols-1 gap-4 content-start">
            
            <div class="bg-tech-gray/10 border border-tech-line p-4 hover:border-tech-accent transition-colors group">
                <div class="flex justify-between items-start mb-2">
                    <span class="font-mono text-xs text-gray-500 group-hover:text-tech-accent">PRECIPITATION</span>
                    <i data-lucide="cloud-rain" class="w-4 h-4 text-gray-600 group-hover:text-tech-accent"></i>
                </div>
                <div class="font-mono text-3xl text-white" id="data-rain">--%</div>
            </div>
            
            <div class="bg-tech-gray/10 border border-tech-line p-4 hover:border-tech-accent transition-colors group relative overflow-hidden">
                <div class="absolute top-0 right-0 w-16 h-16 border-t border-r border-tech-alert opacity-50"></div>
                <div class="flex justify-between items-start mb-2">
                    <span class="font-mono text-xs text-gray-500 group-hover:text-tech-accent">FEELS LIKE</span>
                    <i data-lucide="thermometer" class="w-4 h-4 text-gray-600 group-hover:text-tech-accent"></i>
                </div>
                <div class="font-mono text-3xl text-white" id="data-feels-like">--°C</div>
                <div class="mt-2 font-eva text-sm text-gray-400" id="data-comfort">--</div>
            </div>

            <div class="border border-tech-line border-dashed p-4 flex items-center justify-center opacity-30">
                <span class="font-eva text-xs tracking-[0.5em] text-center">緊急事態對應中心<br>EMERGENCY</span>
            </div>

        </section>
    </main>

    <footer class="w-full border-t border-tech-line py-6 bg-tech-black mt-auto">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="font-eva text-xs text-gray-600 tracking-wider">
                資料來源：交通部中央氣象署
            </p>
            <p class="font-mono text-[10px] text-gray-800 mt-2">
                DESIGNED FOR FREE TAIWAN WEATHER
            </p>
        </div>
    </footer>

    <script>
        // 初始化 Lucide Icons
        lucide.createIcons();

        // 台灣縣市座標資料 (用於計算最近距離)
        const CITIES = [
            { name: "基隆市", lat: 25.1276, lon: 121.7392 },
            { name: "臺北市", lat: 25.0320, lon: 121.5654 },
            { name: "新北市", lat: 25.0170, lon: 121.4625 },
            { name: "桃園市", lat: 24.9936, lon: 121.3010 },
            { name: "新竹市", lat: 24.8138, lon: 120.9675 },
            { name: "新竹縣", lat: 24.8397, lon: 121.0113 },
            { name: "苗栗縣", lat: 24.5607, lon: 120.8213 },
            { name: "臺中市", lat: 24.1477, lon: 120.6736 },
            { name: "彰化縣", lat: 24.0518, lon: 120.5161 },
            { name: "南投縣", lat: 23.9610, lon: 120.9719 },
            { name: "雲林縣", lat: 23.7092, lon: 120.4313 },
            { name: "嘉義市", lat: 23.4801, lon: 120.4491 },
            { name: "嘉義縣", lat: 23.4518, lon: 120.2555 },
            { name: "臺南市", lat: 22.9997, lon: 120.2270 },
            { name: "高雄市", lat: 22.6273, lon: 120.3014 },
            { name: "屏東縣", lat: 22.5519, lon: 120.5487 },
            { name: "宜蘭縣", lat: 24.7021, lon: 121.7377 },
            { name: "花蓮縣", lat: 23.9872, lon: 121.6016 },
            { name: "臺東縣", lat: 22.7583, lon: 121.1444 },
            { name: "澎湖縣", lat: 23.5712, lon: 119.5797 },
            { name: "金門縣", lat: 24.4403, lon: 118.3236 },
            { name: "連江縣", lat: 26.1512, lon: 119.9351 }
        ];

        const API_URL = "https://freeweather.zeabur.app/api/weather/all";
        let weatherDataCache = {};

        // DOM Elements
        const citySelect = document.getElementById('city-select');
        const mainTemp = document.getElementById('main-temp');
        const bgTemp = document.getElementById('bg-temp');
        const weatherDesc = document.getElementById('weather-desc');
        const weatherDetail = document.getElementById('weather-detail');
        const iconContainer = document.getElementById('weather-icon-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        // Data Elements
        // ⚡ 移除對應的 DOM 元素宣告：elHumidity, elWindLevel, elWindDir 已移除
        const elRain = document.getElementById('data-rain');
        const elFeelsLike = document.getElementById('data-feels-like');
        const elComfort = document.getElementById('data-comfort');

        // 時間顯示
        setInterval(() => {
            const now = new Date();
            document.getElementById('system-time').innerText = now.toLocaleTimeString('en-US', { hour12: false });
        }, 1000);

        // 初始化下拉選單
        function initSelect() {
            citySelect.innerHTML = '';
            CITIES.forEach(city => {
                const option = document.createElement('option');
                option.value = city.name;
                option.textContent = city.name;
                citySelect.appendChild(option);
            });
            citySelect.value = "臺中市";
        }

        // Haversine formula for distance
        function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // 尋找最近城市
        function findNearestCity(lat, lon) {
            let minDistance = Infinity;
            let nearestCity = "臺中市";
            CITIES.forEach(city => {
                const dist = getDistanceFromLatLonInKm(lat, lon, city.lat, city.lon);
                if (dist < minDistance) {
                    minDistance = dist;
                    nearestCity = city.name;
                }
            });
            return nearestCity;
        }

        // 取得天氣 ICON
        function getWeatherIcon(desc) {
            if (!desc) return "help-circle";
            if (desc.includes("晴")) return "sun";
            if (desc.includes("雷")) return "cloud-lightning";
            if (desc.includes("雨")) return "cloud-rain";
            if (desc.includes("陰") || desc.includes("雲")) return "cloud";
            if (desc.includes("霧")) return "cloud-fog";
            return "activity";
        }

        // 核心解析邏輯
        function renderWeather(cityName) {
            const data = weatherDataCache[cityName];
            
            if (!data) {
                // 如果 cache 裡沒有這個城市 (可能是 API 還沒回來或失敗)
                if(Object.keys(weatherDataCache).length > 0) {
                     weatherDesc.innerText = "無資料";
                }
                return;
            }

            // 因為 API 回傳的是未來 3 個時段，我們取第 0 個 (最近/現在)
            const current = data.forecasts[0];

            // 處理溫度：API 給的是 "20°C" 字串
            const minT = parseInt(current.minTemp) || 0;
            const maxT = parseInt(current.maxTemp) || 0;
            const avgT = Math.round((minT + maxT) / 2); // 計算平均溫作為主要顯示

            // 更新 DOM
            mainTemp.innerText = avgT;
            bgTemp.innerText = avgT + "°";
            
            weatherDesc.innerText = current.weather;
            weatherDetail.innerText = `[${cityName}] 預報時段 ${current.startTime.split(' ')[1].slice(0,5)} 至 ${current.endTime.split(' ')[1].slice(0,5)}。天氣${current.weather}，氣溫約 ${current.minTemp} 至 ${current.maxTemp}。`;
            
            // 降雨機率
            elRain.innerText = current.rain; // API 已包含 % 符號
            
            // 體感區塊：改顯示溫度範圍
            elFeelsLike.innerText = `${minT}-${maxT}°`;
            elComfort.innerText = current.comfort;

            // ⚡ 程式碼調整：拿掉對已移除欄位 (風速、濕度) 的 DOM 元素賦值操作

            // 更新 Icon
            const iconName = getWeatherIcon(current.weather);
            // ⚡ 修改 3: 放大天氣圖示：將 w-12 h-12 改為 w-24 h-24
            iconContainer.innerHTML = `<i data-lucide="${iconName}" class="w-24 h-24"></i>`;
            lucide.createIcons();
        }

        // 抓取 API
        async function fetchWeather() {
            loadingIndicator.style.opacity = "1";
            try {
                const response = await fetch(API_URL);
                const json = await response.json();

                // 解析你的 API 結構: { success: true, data: [ ... ] }
                if (json.success && Array.isArray(json.data)) {
                    weatherDataCache = {};
                    
                    json.data.forEach(item => {
                        // item.city 是城市名
                        // item.forecasts 是預報陣列
                        if (item.city && item.forecasts && item.forecasts.length > 0) {
                            weatherDataCache[item.city] = item;
                        }
                    });

                    // 渲染當前選中城市
                    renderWeather(citySelect.value);
                } else {
                    throw new Error("API 格式不符");
                }

            } catch (error) {
                console.error("API Error:", error);
                weatherDesc.innerText = "SYSTEM ERR";
                weatherDetail.innerText = "連線失敗，無法取得氣象參數。";
            } finally {
                loadingIndicator.style.opacity = "0";
            }
        }

        // 定位處理
        function handleGeolocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        const nearest = findNearestCity(latitude, longitude);
                        citySelect.value = nearest;
                        renderWeather(nearest);
                    },
                    (error) => {
                        console.log("Location access denied.");
                    }
                );
            }
        }

        // Event Listeners
        citySelect.addEventListener('change', (e) => {
            renderWeather(e.target.value);
        });

        document.getElementById('locate-btn').addEventListener('click', handleGeolocation);

        // App Start
        initSelect();
        fetchWeather().then(() => {
            handleGeolocation();
        });

    </script>
</body>
</html>